\n# Mastery System Integration Guide\n\n## Overview\n\nThis guide explains how to integrate the Command Mastery system with existing InteractiveLearningUnit components.\n\n## Integration Points\n\n### 1. InteractiveLearningUnit Model Integration\n\n```ruby\n# app/models/interactive_learning_unit.rb\n\nclass InteractiveLearningUnit < ApplicationRecord\n  # Existing associations\n  has_many :learning_unit_progresses, dependent: :destroy\n  has_many :module_interactive_units, dependent: :destroy\n  \n  # Add mastery tracking\n  after_create :extract_required_commands\n  \n  # Get required commands for this unit\n  def get_required_commands\n    commands = []\n    \n    # Primary command\n    if command_to_learn.present?\n      canonical = CommandCanonicalizer.new.canonicalize(command_to_learn)\n      commands << canonical if canonical\n    end\n    \n    # Commands from scenario steps\n    if scenario_steps.present?\n      scenario_steps.each do |step|\n        if step['command'].present?\n          canonical = CommandCanonicalizer.new.canonicalize(step['command'])\n          commands << canonical if canonical\n        end\n      end\n    end\n    \n    commands.uniq\n  end\n  \n  # Check if user meets mastery requirements\n  def user_meets_mastery?(user)\n    required = get_required_commands\n    return true if required.empty?\n    \n    service = MasteryTrackingService.new(user)\n    gate_result = service.check_remedial_gate(required)\n    gate_result[:status] == 'ok'\n  end\n  \n  private\n  \n  def extract_required_commands\n    commands = get_required_commands\n    update_column(:required_commands, commands) if commands.any?\n  end\nend\n```\n\n### 2. Interactive Learning Controller Integration\n\n```ruby\n# app/controllers/interactive_learning_controller.rb\n\nclass InteractiveLearningController < ApplicationController\n  before_action :check_mastery_gate, only: [:show]\n  \n  private\n  \n  def check_mastery_gate\n    @unit = InteractiveLearningUnit.find_by!(slug: params[:slug])\n    \n    unless @unit.user_meets_mastery?(current_user)\n      service = MasteryTrackingService.new(current_user)\n      @gate_result = service.check_remedial_gate(@unit.get_required_commands)\n      \n      if @gate_result[:status] == 'blocked'\n        render 'remedial_required' and return\n      end\n    end\n  end\n  \n  # Track mastery on practice completion\n  def complete_practice\n    @unit = InteractiveLearningUnit.find_by!(slug: params[:slug])\n    \n    # Existing practice logic...\n    \n    if params[:correct] == 'true'\n      # Update mastery\n      service = MasteryTrackingService.new(current_user)\n      command = CommandCanonicalizer.new.canonicalize(@unit.command_to_learn)\n      \n      if command\n        service.update_mastery(\n          command: command,\n          context: 'practice',\n          success: true,\n          time_taken: params[:time_taken]\n        )\n      end\n    end\n    \n    # Continue with existing response...\n  end\n  \n  # Track mastery on quiz completion\n  def answer_quiz\n    @unit = InteractiveLearningUnit.find_by!(slug: params[:slug])\n    \n    # Existing quiz logic...\n    \n    if correct\n      # Update mastery\n      service = MasteryTrackingService.new(current_user)\n      command = CommandCanonicalizer.new.canonicalize(@unit.command_to_learn)\n      \n      if command\n        service.update_mastery(\n          command: command,\n          context: 'quiz',\n          success: true,\n          time_taken: params[:time_taken]\n        )\n      end\n    end\n    \n    # Continue with existing response...\n  end\n  \n  # Track mastery on scenario completion\n  def complete_scenario\n    @unit = InteractiveLearningUnit.find_by!(slug: params[:slug])\n    \n    # Existing scenario logic...\n    \n    # Update mastery for all commands used\n    service = MasteryTrackingService.new(current_user)\n    @unit.get_required_commands.each do |command|\n      service.update_mastery(\n        command: command,\n        context: 'lab',\n        success: true,\n        time_taken: params[:time_taken]\n      )\n    end\n    \n    # Continue with existing response...\n  end\nend\n```\n\n### 3. React Component Integration\n\n#### InteractiveLearningFlow.jsx Updates\n\n```javascript\n// app/javascript/components/InteractiveLearningFlow.jsx\n\nimport React, { useState, useEffect } from 'react';\nimport RemedialDrill from './RemedialDrill';\n// ... other imports\n\nconst InteractiveLearningFlow = ({ unit, initialProgress, csrfToken, streamNextPath }) => {\n  const [remedialRequired, setRemedialRequired] = useState(false);\n  const [remedialCommands, setRemedialCommands] = useState([]);\n  const [currentStep, setCurrentStep] = useState(1);\n  \n  // Check remedial gate before Apply step\n  useEffect(() => {\n    if (currentStep === 4 && !progress.scenario_completed) {\n      checkRemedialGate();\n    }\n  }, [currentStep]);\n  \n  const checkRemedialGate = async () => {\n    try {\n      const response = await fetch(`/interactive_learning/${unit.slug}/remedial_gate`);\n      const data = await response.json();\n      \n      if (data.status === 'blocked') {\n        setRemedialRequired(true);\n        setRemedialCommands(data.blocked_commands);\n      }\n    } catch (error) {\n      console.error('Error checking remedial gate:', error);\n    }\n  };\n  \n  const handleRemedialComplete = () => {\n    setRemedialRequired(false);\n    setRemedialCommands([]);\n    // Continue to Apply step\n  };\n  \n  // ... rest of component\n  \n  return (\n    <div className=\"max-w-4xl mx-auto p-6\">\n      {/* ... existing header ... */}\n      \n      <div className=\"bg-white rounded-lg shadow-lg p-8\">\n        {/* Show remedial drill if required */}\n        {remedialRequired && currentStep === 4 ? (\n          <RemedialDrill\n            commands={remedialCommands}\n            unitSlug={unit.slug}\n            csrfToken={csrfToken}\n            onComplete={handleRemedialComplete}\n          />\n        ) : (\n          <>\n            {/* ... existing step components ... */}\n          </>\n        )}\n      </div>\n    </div>\n  );\n};\n```\n\n#### CommandPracticeEnhanced.jsx Updates\n\n```javascript\n// app/javascript/components/CommandPracticeEnhanced.jsx\n\nconst CommandPractice = ({ unit, csrfToken, onComplete, attempts }) => {\n  // ... existing code ...\n  \n  const handleSubmit = async () => {\n    // ... existing validation ...\n    \n    const response = await fetch(`/interactive_learning/${unit.slug}/complete_practice`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'X-CSRF-Token': csrfToken\n      },\n      body: JSON.stringify({\n        command_entered: userInput,\n        correct: isCorrect,\n        time_taken: Math.floor((Date.now() - startTime) / 1000),\n        attempt_number: attempts + 1\n      })\n    });\n    \n    // ... rest of handler\n  };\n};\n```\n\n### 4. Database Seeds Integration\n\n```ruby\n# db/seeds/interactive_learning_units.rb\n\n# After creating units, extract and set required commands\nInteractiveLearningUnit.find_each do |unit|\n  commands = []\n  \n  # Extract from command_to_learn\n  if unit.command_to_learn.present?\n    canonical = CommandCanonicalizer.new.canonicalize(unit.command_to_learn)\n    commands << canonical if canonical\n  end\n  \n  # Extract from scenario_steps\n  if unit.scenario_steps.present?\n    unit.scenario_steps.each do |step|\n      if step['command'].present?\n        canonical = CommandCanonicalizer.new.canonicalize(step['command'])\n        commands << canonical if canonical\n      end\n    end\n  end\n  \n  # 
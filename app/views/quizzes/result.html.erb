<div class="container py-4">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><%= link_to "Dashboard", dashboard_path %></li>
      <% if @course %>
        <li class="breadcrumb-item"><%= link_to "Courses", courses_path %></li>
        <li class="breadcrumb-item"><%= link_to @course.title, course_path(@course) %></li>
        <li class="breadcrumb-item"><%= link_to @course_module.title, course_module_path(@course, @course_module) %></li>
      <% end %>
      <li class="breadcrumb-item"><%= link_to @quiz.title, quiz_path(@quiz) %></li>
      <li class="breadcrumb-item active" aria-current="page">Results</li>
    </ol>
  </nav>

  <!-- Results Header -->
  <div class="row mb-4">
    <div class="col-lg-8 mx-auto">
      <div class="card border-0 shadow-lg <%= @attempt.passed? ? 'border-success' : 'border-danger' %>" style="border-left: 5px solid <%= @attempt.passed? ? '#28a745' : '#dc3545' %> !important;">
        <div class="card-body p-4 text-center">
          <div class="mb-3">
            <% if @attempt.passed? %>
              <i class="fas fa-trophy text-warning" style="font-size: 4rem;"></i>
              <h2 class="mt-3 text-success">üéâ Congratulations!</h2>
              <p class="lead">You passed the quiz!</p>
            <% else %>
              <i class="fas fa-times-circle text-danger" style="font-size: 4rem;"></i>
              <h2 class="mt-3 text-danger">Keep Trying!</h2>
              <p class="lead">You didn't pass this time, but you can try again.</p>
            <% end %>
          </div>

          <!-- Score Display -->
          <div class="row text-center mb-4">
            <div class="col-md-3 col-6 mb-3">
              <div class="p-3 bg-light rounded">
                <h3 class="mb-0"><%= @attempt.score %>%</h3>
                <small class="text-muted">Score</small>
              </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
              <div class="p-3 bg-light rounded">
                <h3 class="mb-0 text-success"><%= @attempt.correct_answers %></h3>
                <small class="text-muted">Correct</small>
              </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
              <div class="p-3 bg-light rounded">
                <h3 class="mb-0 text-danger"><%= @attempt.total_questions - @attempt.correct_answers %></h3>
                <small class="text-muted">Incorrect</small>
              </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
              <div class="p-3 bg-light rounded">
                <h3 class="mb-0"><%= @attempt.time_taken_display %></h3>
                <small class="text-muted">Time Taken</small>
              </div>
            </div>
          </div>

          <!-- Performance Badge -->
          <div class="mb-3">
            <span class="badge badge-lg <%= @attempt.score_badge_class %> p-3" style="font-size: 1.1rem;">
              <%= @attempt.performance_level %>
            </span>
          </div>

          <!-- Points Earned -->
          <% if @attempt.passed? %>
            <div class="alert alert-success mt-3">
              <i class="fas fa-coins"></i>
              <strong>Points Earned:</strong> 
              <% base_points = @quiz.quiz_questions.sum(:points) %>
              <% if @attempt.attempt_number == 1 %>
                <%= (base_points * 1.5).round %> points (Base: <%= base_points %> + First Attempt Bonus!)
              <% elsif @attempt.score == 100 %>
                <%= (base_points * 1.2).round %> points (Base: <%= base_points %> + Perfect Score Bonus!)
              <% else %>
                <%= base_points %> points
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <%# Practice Quiz Specific Content %>
  <% if @quiz.practice_quiz? %>
    <div class="row mb-4">
      <div class="col-lg-8 mx-auto">
        <% if @quiz.review_session? %>
          <%# Review Session - Show next review schedule %>
          <div class="card border-primary">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0"><i class="fas fa-calendar-check"></i> Spaced Repetition Progress</h5>
            </div>
            <div class="card-body">
              <p>Great job completing your review session! Your spaced repetition schedule has been updated.</p>
              <%# TODO: Show next review dates for each item %>
              <div class="alert alert-info">
                <strong>üìÖ Next Review:</strong>
                Items will be reviewed based on your performance:
                <ul class="mb-0 mt-2">
                  <li>Correct answers: Next review in 2-7 days</li>
                  <li>Incorrect answers: Next review tomorrow</li>
                </ul>
              </div>
              <%= link_to "Back to Practice Dashboard", practice_quizzes_path, class: "btn btn-primary" %>
            </div>
          </div>
        <% elsif @quiz.topic_deepdive? %>
          <%# Topic Deep-Dive - Show skill improvement %>
          <div class="card border-info">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0"><i class="fas fa-chart-line"></i> Topic Mastery Progress</h5>
            </div>
            <div class="card-body">
              <% topic = @quiz.metadata['topic'] %>
              <p>You practiced: <strong><%= topic %></strong></p>
              <div class="alert alert-success">
                <strong>üìä Performance:</strong> <%= @attempt.score %>% accuracy
                <% if @attempt.score >= 80 %>
                  <br><span class="badge bg-success mt-2">üéØ Excellent understanding of <%= topic %>!</span>
                <% elsif @attempt.score >= 60 %>
                  <br><span class="badge bg-warning mt-2">üìà Good progress! Keep practicing <%= topic %></span>
                <% else %>
                  <br><span class="badge bg-danger mt-2">üí™ <%= topic %> needs more practice</span>
                <% end %>
              </div>
              <%= link_to "Practice Another Topic", practice_quizzes_path, class: "btn btn-info" %>
            </div>
          </div>
        <% elsif @quiz.mastery_challenge? %>
          <%# Mastery Challenge - Show speed performance %>
          <div class="card border-danger">
            <div class="card-header bg-danger text-white">
              <h5 class="mb-0"><i class="fas fa-fire"></i> Mastery Challenge Results</h5>
            </div>
            <div class="card-body">
              <% avg_time_per_q = @attempt.time_taken / @quiz.total_questions.to_f %>
              <% target_time = @quiz.metadata['target_time_per_question'] || 30 %>
              <% speed_bonus = avg_time_per_q <= target_time %>

              <div class="row text-center mb-3">
                <div class="col-md-4">
                  <div class="p-3 bg-light rounded">
                    <h4 class="mb-0"><%= avg_time_per_q.round %>s</h4>
                    <small class="text-muted">Avg per question</small>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="p-3 bg-light rounded">
                    <h4 class="mb-0"><%= @quiz.time_limit_minutes %> min</h4>
                    <small class="text-muted">Time limit</small>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="p-3 <%= speed_bonus ? 'bg-success text-white' : 'bg-light' %> rounded">
                    <h4 class="mb-0"><%= speed_bonus ? '‚ö° BONUS!' : 'üòä OK' %></h4>
                    <small class="<%= speed_bonus ? 'text-white' : 'text-muted' %>">Speed</small>
                  </div>
                </div>
              </div>

              <% if @attempt.score >= 80 && speed_bonus %>
                <div class="alert alert-warning text-center">
                  <h5 class="mb-0">üèÜ MASTERY ACHIEVED! üèÜ</h5>
                  <p class="mb-0 mt-2">High score + Speed bonus = Master level!</p>
                </div>
              <% end %>

              <%= link_to "Take Another Challenge", practice_quizzes_path, class: "btn btn-danger" %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Question Review Section -->
  <div class="row">
    <div class="col-lg-8 mx-auto">
      <h3 class="mb-3">Question Review</h3>
      
      <!-- Correct Answers Section -->
      <% if @correct_questions.any? %>
        <div class="card border-success mb-4">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">
              <i class="fas fa-check-circle"></i> 
              Correct Answers (<%= @correct_questions.count %>)
            </h5>
          </div>
          <div class="card-body">
            <div class="accordion" id="correctAnswersAccordion">
              <% @correct_questions.each_with_index do |question, index| %>
                <div class="card mb-2">
                  <div class="card-header p-2" id="correct-heading-<%= question.id %>">
                    <button class="btn btn-link text-success text-decoration-none w-100 text-left collapsed" type="button" data-toggle="collapse" data-target="#correct-collapse-<%= question.id %>" aria-expanded="false">
                      <i class="fas fa-check-circle"></i>
                      <strong>Question <%= index + 1 %>:</strong> <%= question.question_text.truncate(80) %>
                    </button>
                  </div>
                  <div id="correct-collapse-<%= question.id %>" class="collapse" aria-labelledby="correct-heading-<%= question.id %>" data-parent="#correctAnswersAccordion">
                    <div class="card-body">
                      <p class="mb-2"><strong>Question:</strong> <%= question.question_text %></p>
                      <p class="mb-2"><strong>Your Answer:</strong> 
                        <span class="badge badge-success"><%= @attempt.answer_for(question) %></span>
                      </p>
                      <% if question.explanation.present? %>
                        <div class="alert alert-info mt-2">
                          <strong><i class="fas fa-lightbulb"></i> Explanation:</strong><br>
                          <%= question.explanation %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Incorrect Answers Section -->
      <% if @incorrect_questions.any? %>
        <div class="card border-danger mb-4">
          <div class="card-header bg-danger text-white">
            <h5 class="mb-0">
              <i class="fas fa-times-circle"></i> 
              Incorrect Answers (<%= @incorrect_questions.count %>)
            </h5>
          </div>
          <div class="card-body">
            <div class="alert alert-warning">
              <i class="fas fa-info-circle"></i>
              These questions have been added to your review schedule. You'll see them again in your daily practice.
            </div>
            
            <div class="accordion" id="incorrectAnswersAccordion">
              <% @incorrect_questions.each_with_index do |question, index| %>
                <div class="card mb-2 border-danger">
                  <div class="card-header p-2 bg-light" id="incorrect-heading-<%= question.id %>">
                    <button class="btn btn-link text-danger text-decoration-none w-100 text-left" type="button" data-toggle="collapse" data-target="#incorrect-collapse-<%= question.id %>" aria-expanded="true">
                      <i class="fas fa-times-circle"></i>
                      <strong>Question <%= index + 1 %>:</strong> <%= question.question_text.truncate(80) %>
                    </button>
                  </div>
                  <div id="incorrect-collapse-<%= question.id %>" class="collapse show" aria-labelledby="incorrect-heading-<%= question.id %>" data-parent="#incorrectAnswersAccordion">
                    <div class="card-body">
                      <p class="mb-3"><strong>Question:</strong> <%= question.question_text %></p>
                      
                      <div class="row">
                        <div class="col-md-6 mb-2">
                          <strong>Your Answer:</strong>
                          <div class="p-2 bg-danger text-white rounded">
                            <i class="fas fa-times"></i> <%= @attempt.answer_for(question) || "Not answered" %>
                          </div>
                        </div>
                        <div class="col-md-6 mb-2">
                          <strong>Correct Answer:</strong>
                          <div class="p-2 bg-success text-white rounded">
                            <i class="fas fa-check"></i> <%= question.correct_answer %>
                          </div>
                        </div>
                      </div>

                      <% if question.explanation.present? %>
                        <div class="alert alert-info mt-3">
                          <strong><i class="fas fa-lightbulb"></i> Explanation:</strong><br>
                          <%= question.explanation %>
                        </div>
                      <% end %>

                      <% if question.hint.present? %>
                        <div class="alert alert-secondary mt-2">
                          <strong><i class="fas fa-question-circle"></i> Hint:</strong><br>
                          <%= question.hint %>
                        </div>
                      <% end %>
                      
                      <% if @remediation_data %>
                        <div class="mt-3">
                          <button type="button" 
                                  class="btn btn-sm btn-info review-wrong-answer-btn" 
                                  data-question-id="<%= question.id %>">
                            <i class="fas fa-book-reader"></i> Get Personalized Help
                          </button>
                        </div>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Navigation Actions -->
      <div class="card">
        <div class="card-body">
          <h5 class="mb-3">What's Next?</h5>
          <div class="d-flex flex-wrap gap-2">
            <!-- Retry Quiz -->
            <% if !@attempt.passed? && @quiz.can_attempt?(current_user) %>
              <%= link_to start_quiz_path(@quiz), method: :post, class: "btn btn-warning mr-2 mb-2" do %>
                <i class="fas fa-redo"></i> Try Same Quiz Again
              <% end %>
              
              <!-- Adaptive Retry Button -->
              <% if @remediation_data %>
                <%= link_to adaptive_retry_quiz_path(@quiz, attempt_id: @attempt.id), method: :post, class: "btn btn-success mr-2 mb-2" do %>
                  <i class="fas fa-brain"></i> Smart Practice Quiz
                <% end %>
                
                <!-- Remediation Help Button -->
                <button type="button" class="btn btn-info mr-2 mb-2" data-bs-toggle="modal" data-bs-target="#wrongAnswerModal">
                  <i class="fas fa-graduation-cap"></i> Review Mistakes
                </button>
              <% end %>
            <% end %>

            <!-- Continue to Next Item -->
            <% if @attempt.passed? && @next_item %>
              <% if @next_item.item_type == 'Lesson' %>
                <%= link_to course_module_lesson_path(@course, @course_module, @next_item.item), class: "btn btn-primary mr-2 mb-2" do %>
                  <i class="fas fa-forward"></i> Continue to Next Lesson
                <% end %>
              <% elsif @next_item.item_type == 'Quiz' %>
                <%= link_to quiz_path(@next_item.item), class: "btn btn-primary mr-2 mb-2" do %>
                  <i class="fas fa-forward"></i> Continue to Next Quiz
                <% end %>
              <% elsif @next_item.item_type == 'HandsOnLab' %>
                <%= link_to hands_on_lab_path(@next_item.item), class: "btn btn-primary mr-2 mb-2" do %>
                  <i class="fas fa-forward"></i> Continue to Next Lab
                <% end %>
              <% end %>
            <% end %>

            <!-- Back to Quiz Overview -->
            <%= link_to quiz_path(@quiz), class: "btn btn-secondary mr-2 mb-2" do %>
              <i class="fas fa-arrow-left"></i> Back to Quiz
            <% end %>

            <!-- Back to Module -->
            <% if @course && @course_module %>
              <%= link_to course_module_path(@course, @course_module), class: "btn btn-outline-secondary mr-2 mb-2" do %>
                <i class="fas fa-list"></i> Back to Module
              <% end %>
            <% end %>

            <!-- Back to Course -->
            <% if @course %>
              <%= link_to course_path(@course), class: "btn btn-outline-secondary mr-2 mb-2" do %>
                <i class="fas fa-book"></i> Back to Course
              <% end %>
            <% end %>

            <!-- Dashboard -->
            <%= link_to dashboard_path, class: "btn btn-outline-secondary mb-2" do %>
              <i class="fas fa-home"></i> Dashboard
            <% end %>
          </div>
        </div>
      </div>

      <!-- Study Tips -->
      <% if !@attempt.passed? %>
        <div class="card mt-4 border-info">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-graduation-cap"></i> Study Tips</h5>
          </div>
          <div class="card-body">
            <ul class="mb-0">
              <li>Review the explanations for each incorrect answer above</li>
              <li>Practice the questions added to your review schedule</li>
              <li>Revisit the lesson materials before attempting again</li>
              <li>Take notes on concepts you find challenging</li>
              <% if @quiz.max_attempts && @quiz.attempts_for(current_user).count < @quiz.max_attempts %>
                <li>You have <%= @quiz.max_attempts - @quiz.attempts_for(current_user).count %> attempts remaining</li>
              <% end %>
            </ul>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<style>
  .badge-lg {
    font-size: 1rem;
    padding: 0.5rem 1rem;
  }
  
  .gap-2 {
    gap: 0.5rem;
  }
  
  .accordion .btn-link {
    font-size: 0.95rem;
    padding: 0.5rem;
  }
  
  .accordion .btn-link:hover {
    text-decoration: none;
  }
  
  .bg-light {
    background-color: #f8f9fa !important;
  }
</style>

<% if @remediation_data %>
  <%= render 'remediation/wrong_answer_modal' %>
  
  <script>
    // Initialize remediation data when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Pre-load remediation data for quick access
      const remediationData = <%= raw @remediation_data.to_json %>;
      console.log('Remediation data loaded:', remediationData);
      
      // Add click handlers to each incorrect answer to show modal with context
      document.querySelectorAll('.review-wrong-answer-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const questionId = this.dataset.questionId;
          const questionData = remediationData.immediate_recommendations.find(
            r => r.question_id == questionId
          );
          const lessonMapping = remediationData.lesson_mappings.find(
            m => m.question_id == questionId
          );
          
          if (questionData) {
            showWrongAnswerModal({
              ...questionData,
              lesson_mappings: lessonMapping,
              quiz_attempt_id: <%= @attempt.id %>
            });
          }
        });
      });
    });
  </script>
<% end %>
\nrequire 'rails_helper'\n\nRSpec.describe MasteryTrackingService do\n  let(:user) { create(:user) }\n  let(:service) { described_class.new(user) }\n\n  describe '#update_mastery' do\n    context 'when creating new mastery record' do\n      it 'creates a new mastery record for first attempt' do\n        expect {\n          service.update_mastery(\n            command: 'docker_run',\n            context: 'practice',\n            success: true,\n            time_taken: 30\n          )\n        }.to change { UserCommandMastery.count }.by(1)\n      end\n\n      it 'sets initial values correctly' do\n        service.update_mastery(\n          command: 'docker_run',\n          context: 'practice',\n          success: true,\n          time_taken: 30\n        )\n\n        mastery = UserCommandMastery.last\n        expect(mastery.canonical_command).to eq('docker_run')\n        expect(mastery.proficiency_score).to be > 0\n        expect(mastery.total_attempts).to eq(1)\n        expect(mastery.successful_attempts).to eq(1)\n        expect(mastery.practice_successes).to eq(1)\n      end\n    end\n\n    context 'when updating existing mastery' do\n      let!(:existing_mastery) do\n        UserCommandMastery.create!(\n          user: user,\n          canonical_command: 'docker_run',\n          proficiency_score: 0.5,\n          total_attempts: 5,\n          successful_attempts: 3,\n          practice_attempts: 5,\n          practice_successes: 3\n        )\n      end\n\n      it 'updates existing record' do\n        expect {\n          service.update_mastery(\n            command: 'docker_run',\n            context: 'practice',\n            success: true,\n            time_taken: 25\n          )\n        }.not_to change { UserCommandMastery.count }\n\n        existing_mastery.reload\n        expect(existing_mastery.total_attempts).to eq(6)\n        expect(existing_mastery.successful_attempts).to eq(4)\n      end\n\n      it 'updates proficiency score on success' do\n        initial_score = existing_mastery.proficiency_score\n        \n        service.update_mastery(\n          command: 'docker_run',\n          context: 'practice',\n          success: true,\n          time_taken: 20\n        )\n\n        existing_mastery.reload\n        expect(existing_mastery.proficiency_score).to be > initial_score\n      end\n\n      it 'decreases proficiency score on failure' do\n        initial_score = existing_mastery.proficiency_score\n        \n        service.update_mastery(\n          command: 'docker_run',\n          context: 'practice',\n          success: false,\n          time_taken: 60\n        )\n\n        existing_mastery.reload\n        expect(existing_mastery.proficiency_score).to be < initial_score\n      end\n\n      it 'caps proficiency at 1.0' do\n        existing_mastery.update!(proficiency_score: 0.95)\n        \n        service.update_mastery(\n          command: 'docker_run',\n          context: 'lab',\n          success: true,\n          time_taken: 15\n        )\n\n        existing_mastery.reload\n        expect(existing_mastery.proficiency_score).to eq(1.0)\n      end\n\n      it 'does not go below 0.0' do\n        existing_mastery.update!(proficiency_score: 0.05)\n        \n        service.update_mastery(\n          command: 'docker_run',\n          context: 'practice',\n          success: false,\n          time_taken: 90\n        )\n\n        existing_mastery.reload\n        expect(existing_mastery.proficiency_score).to eq(0.0)\n      end\n    end\n\n    context 'with different contexts' do\n      it 'tracks practice context' do\n        service.update_mastery(\n          command: 'docker_ps',\n          context: 'practice',\n          success: true\n        )\n\n        mastery = UserCommandMastery.last\n        expect(mastery.practice_attempts).to eq(1)\n        expect(mastery.practice_successes).to eq(1)\n        expect(mastery.contexts_seen).to include('practice')\n      end\n\n      it 'tracks quiz context' do\n        service.update_mastery(\n          command: 'docker_ps',\n          context: 'quiz',\n          success: true\n        )\n\n        mastery = UserCommandMastery.last\n        expect(mastery.quiz_attempts).to eq(1)\n        expect(mastery.quiz_successes).to eq(1)\n        expect(mastery.contexts_seen).to include('quiz')\n      end\n\n      it 'tracks lab context' do\n        service.update_mastery(\n          command: 'docker_ps',\n          context: 'lab',\n          success: true\n        )\n\n        mastery = UserCommandMastery.last\n        expect(mastery.lab_attempts).to eq(1)\n        expect(mastery.lab_successes).to eq(1)\n        expect(mastery.contexts_seen).to include('lab')\n      end\n\n      it 'applies different weights for different contexts' do\n        # Practice has 0.2 weight\n        service.update_mastery(command: 'docker_build', context: 'practice', success: true)\n        practice_score = UserCommandMastery.last.proficiency_score\n\n        # Quiz has 0.3 weight\n        UserCommandMastery.destroy_all\n        service.update_mastery(command: 'docker_build', context: 'quiz', success: true)\n        quiz_score = UserCommandMastery.last.proficiency_score\n\n        # Lab has 0.4 weight\n        UserCommandMastery.destroy_all\n        service.update_mastery(command: 'docker_build', context: 'lab', success: true)\n        lab_score = UserCommandMastery.last.proficiency_score\n\n        expect(lab_score).to be > quiz_score\n        expect(quiz_score).to be > practice_score\n      end\n    end\n\n    context 'with temporal tracking' do\n      it 'updates last_practiced_at' do\n        freeze_time do\n          service.update_mastery(\n            command: 'docker_exec',\n            context: 'practice',\n            success: true\n          )\n\n          mastery = UserCommandMastery.last\n          expect(mastery.last_practiced_at).to eq(Time.current)\n        end\n      end\n\n      it 'updates last_correct_at on success' do\n        freeze_time do\n          service.update_mastery(\n            command: 'docker_exec',\n            context: 'practice',\n            success: true\n          )\n\n          mastery = UserCommandMastery.last\n          expect(mastery.last_correct_at).to eq(Time.current)\n        end\n      end\n\n      it 'does not update last_correct_at on failure' do\n        service.update_mastery(\n          command: 'docker_exec',\n          context: 'practice',\n          success: true\n        )\n\n        mastery = UserCommandMastery.last\n        last_correct = mastery.last_correct_at\n\n        travel 1.hour\n\n        service.update_mastery(\n          command: 'docker_exec',\n          context: 'practice',\n          success: false\n        )\n\n        mastery.reload\n        expect(mastery.last_correct_at).to eq(last_correct)\n      end\n    end\n  end\n\n  describe '#check_remedial_gate' do\n    context 'with no existing mastery' do\n      it 'blocks all commands' do\n        result = service.check_remedial_gate(['docker_run', 'docker_ps'])\n        \n        expect(result[:status]).to eq('blocked')\n        expect(result[:blocked_commands]).to contain_exactly(\n          { command: 'docker_run', proficiency: 0 },\n          { command: 'docker_ps', proficiency: 0 }\n        )\n      end\n    end\n\n    context 'with partial mastery' do\n      before do\n        UserCommandMastery.create!(\n          user: user,\n          canonical_command: 'docker_run',\n          proficiency_score: 0.8\n        )\n        UserCommandMastery.create!(\n          user: user,\n          canonical_command: 'docker_ps',\n          proficiency_score: